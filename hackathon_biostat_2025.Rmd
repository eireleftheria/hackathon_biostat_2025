---
title: "hackathon_biostat_2025"
output: html_document
date: "2025-11-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(flextable)

CrohnD <- read.csv("data/CrohnD.csv")
```

<h1 style="text-align: center;">Таблицы с базовыми описательными статистиками</h1>

<h2 style="text-align: center;">Количественные переменные</h2>
```{r, echo=FALSE, error=FALSE, warning=FALSE, message=FALSE}

num_table <- CrohnD %>% 
  summarise(
    .by = treat,
    across(c(nrAdvE, age, BMI, weight, height) & !c(rownames, ID), 
           list(
             N = ~sum(!is.na(.x)) %>% as.character(),
             `NA` = ~sum(is.na(.x)) %>% as.character(),
             Среднее = ~ifelse(sum(!is.na(.x)) == 0, "Н/Д", round(mean(.x, na.rm = TRUE), 2) %>% as.character()),
             `Ст. отклон.` = ~ifelse(sum(!is.na(.x)) < 2, "Н/Д", round(sd(.x, na.rm = TRUE), 2) %>% as.character()),
             `Мин - Макс` = ~ifelse(sum(!is.na(.x)) == 0, "Н/Д", paste0(round(min(.x, na.rm = TRUE), 2), " - ", round(max(.x, na.rm = TRUE), 2))),
             Медиана = ~ifelse(sum(!is.na(.x)) == 0, "Н/Д", round(median(.x, na.rm = TRUE), 2) %>% as.character()),
             `Q1 - Q3` = ~ifelse(sum(!is.na(.x)) == 0, "Н/Д", paste0(round(quantile(.x, 0.25, na.rm = TRUE), 2), " - ", round(quantile(.x, 0.75, na.rm = TRUE), 2)))
           )
    )
  ) %>% 
  pivot_longer(!treat, names_to = c("Переменная", "Статистика"), names_sep = "_") %>% 
  pivot_wider(names_from = "Статистика", values_from = "value") %>%
  mutate(
    Переменная = case_when(
      Переменная == "nrAdvE" ~ "Нежелательные явления",
      Переменная == "BMI" ~ "ИМТ",
      Переменная == "height" ~ "Рост",
      Переменная == "age" ~ "Возраст",
      Переменная == "weight" ~ "Вес",
      TRUE ~ Переменная
    ),
    treat = case_when(
      treat == "placebo" ~ "Плацебо",
      treat == "d1" ~ "Препарат 1",
      treat == "d2" ~ "Препарат 2",
      TRUE ~ treat
    )
  ) %>%
  rename(Препарат = treat)

ft_num <- flextable(num_table) %>%
  merge_v(j = 1) %>% 
  fontsize(size = 10) %>%
  bold(part = "header") %>%
  align(j = 1:2, align = "left", part = "all") %>%  
  align(j = 3:9, align = "center", part = "all") %>%  
  border_outer() %>%
  border_inner_h() %>%
  border_inner_v() %>%
  set_table_properties(layout = "autofit") %>%
  bg(part = "header", bg = "pink") 

ft_num
```

<h2 style="text-align: center;">Категориальные переменные</h2>

```{r, echo=FALSE, error=FALSE, warning=FALSE, message=FALSE}
cat_table <- CrohnD %>% 
  summarise(
    .by = treat,
    country_c1_n = sum(country == "c1", na.rm = TRUE) %>% as.character(),
    country_c1_p = ifelse(sum(!is.na(country)) == 0, "Н/Д", 
                         round(sum(country == "c1", na.rm = TRUE) / sum(!is.na(country)) * 100, 1) %>% paste0("%")),
    country_c2_n = sum(country == "c2", na.rm = TRUE) %>% as.character(),
    country_c2_p = ifelse(sum(!is.na(country)) == 0, "Н/Д", 
                         round(sum(country == "c2", na.rm = TRUE) / sum(!is.na(country)) * 100, 1) %>% paste0("%")),
    sex_F_n = sum(sex == "F", na.rm = TRUE) %>% as.character(),
    sex_F_p = ifelse(sum(!is.na(sex)) == 0, "Н/Д", 
                    round(sum(sex == "F", na.rm = TRUE) / sum(!is.na(sex)) * 100, 1) %>% paste0("%")),
    sex_M_n = sum(sex == "M", na.rm = TRUE) %>% as.character(),
    sex_M_p = ifelse(sum(!is.na(sex)) == 0, "Н/Д", 
                    round(sum(sex == "M", na.rm = TRUE) / sum(!is.na(sex)) * 100, 1) %>% paste0("%"))
  ) %>% 
  pivot_longer(!treat, names_to = "variable", values_to = "value") %>%
  separate(variable, into = c("Переменная", "Уровень", "Тип"), sep = "_") %>%
  pivot_wider(names_from = "Тип", values_from = "value") %>%
  mutate(
    Переменная = case_when(
      Переменная == "country" ~ "Страна",
      Переменная == "sex" ~ "Пол",
      TRUE ~ Переменная
    ),
    Уровень = case_when(
      Уровень == "c1" ~ "Страна 1",
      Уровень == "c2" ~ "Страна 2", 
      Уровень == "F" ~ "Женщины",
      Уровень == "M" ~ "Мужчины",
      TRUE ~ Уровень
    ),
    treat = case_when(
      treat == "placebo" ~ "Плацебо",
      treat == "d1" ~ "Препарат 1",
      treat == "d2" ~ "Препарат 2",
      TRUE ~ treat
    )
  ) %>%
  rename(
    Препарат = treat,
    `Количество` = n,
    `%` = p
  ) %>%
  select(Препарат, Переменная, Уровень, `Количество`, `%`)

ft_cat <- flextable(cat_table) %>%
  merge_v(j = "Препарат") %>%
  merge_v(j = "Переменная") %>%
  fontsize(size = 10) %>%
  bold(part = "header") %>%
  align(j = 1:3, align = "left", part = "all") %>%  
  align(j = 4:5, align = "center", part = "all") %>%  
  border_outer() %>%
  border_inner_h() %>%
  border_inner_v() %>%
  set_table_properties(layout = "autofit") %>%
  bg(part = "header", bg = "pink")

ft_cat
```


2. Визуализировать распределения значений признаков средствами ggplot2 и сопутствующих пакетов.
```{r}

```

3. Подобрать и реализовать средства для визуальной оценки взаимосвязи между числом НЯ и собранными признаками пациентов.
```{r fig.height=8, fig.width=13}
library(psych)
library(GGally)
library(patchwork)

CrohnD %>% 
  select(-rownames, -ID) %>% 
  mutate(
    sex = factor(sex),
    country = factor(country),
    treat = factor(treat)
  ) -> corr_data

ggpairs(
  data = corr_data,
  progress = FALSE,
  upper = list(continuous = wrap("cor", method = "spearman"))
) +
  theme_bw()

# пол
p1 <- ggplot(corr_data, aes(x = sex, y = nrAdvE)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.4) +
  theme_bw() +
  labs(title = "Число НЯ по полу")

# лечение
p2 <- ggplot(corr_data, aes(x = treat, y = nrAdvE)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.4) +
  theme_bw() +
  labs(title = "Число НЯ по лечению")

# страна
p3 <- ggplot(corr_data, aes(x = country, y = nrAdvE)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.4) +
  theme_bw() +
  labs(title = "Число НЯ по стране")

p1+p2+p3
# num_corr <- corr_data %>%
#   select(where(is.numeric)) %>%
#   psych::corr.test(method = "spearman")
# 
# ggcorrplot(
#   num_corr$r,
#   hc.order = TRUE,
#   type = "lower",
#   p.mat = num_corr$p,
#   sig.level = 0.05,
#   lab = TRUE
# )



str(CrohnD)
describe(CrohnD)
```

4. Выбрать и реализовать методы однофакторного анализа для количественной оценки взаимосвязи между числом НЯ и собранными признаками пациентов (помните, что взаимосвязь - это не только p-значения, но и доверительные интервалы!).
```{r}

```









