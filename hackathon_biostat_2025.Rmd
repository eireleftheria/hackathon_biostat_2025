---
title: "hackathon_biostat_2025"
output: html_document
date: "2025-11-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(flextable)
library(patchwork)
library(psych)
library(GGally)

CrohnD <- read.csv("data/CrohnD.csv")
```

<h1 style="text-align: center;">Таблицы с базовыми описательными статистиками</h1>

<h2 style="text-align: center;">Количественные переменные</h2>
```{r, echo=FALSE, error=FALSE, warning=FALSE, message=FALSE}

num_table <- CrohnD %>% 
  summarise(
    .by = treat,
    across(c(nrAdvE, age, BMI, weight, height) & !c(rownames, ID), 
           list(
             N = ~sum(!is.na(.x)) %>% as.character(),
             `NA` = ~sum(is.na(.x)) %>% as.character(),
             Среднее = ~ifelse(sum(!is.na(.x)) == 0, "Н/Д", round(mean(.x, na.rm = TRUE), 2) %>% as.character()),
             `Ст. отклон.` = ~ifelse(sum(!is.na(.x)) < 2, "Н/Д", round(sd(.x, na.rm = TRUE), 2) %>% as.character()),
             `Мин - Макс` = ~ifelse(sum(!is.na(.x)) == 0, "Н/Д", paste0(round(min(.x, na.rm = TRUE), 2), " - ", round(max(.x, na.rm = TRUE), 2))),
             Медиана = ~ifelse(sum(!is.na(.x)) == 0, "Н/Д", round(median(.x, na.rm = TRUE), 2) %>% as.character()),
             `Q1 - Q3` = ~ifelse(sum(!is.na(.x)) == 0, "Н/Д", paste0(round(quantile(.x, 0.25, na.rm = TRUE), 2), " - ", round(quantile(.x, 0.75, na.rm = TRUE), 2)))
           )
    )
  ) %>% 
  pivot_longer(!treat, names_to = c("Переменная", "Статистика"), names_sep = "_") %>% 
  pivot_wider(names_from = "Статистика", values_from = "value") %>%
  mutate(
    Переменная = case_when(
      Переменная == "nrAdvE" ~ "Нежелательные явления",
      Переменная == "BMI" ~ "ИМТ",
      Переменная == "height" ~ "Рост",
      Переменная == "age" ~ "Возраст",
      Переменная == "weight" ~ "Вес",
      TRUE ~ Переменная
    ),
    treat = case_when(
      treat == "placebo" ~ "Плацебо",
      treat == "d1" ~ "Препарат 1",
      treat == "d2" ~ "Препарат 2",
      TRUE ~ treat
    )
  ) %>%
  rename(Препарат = treat)

ft_num <- flextable(num_table) %>%
  merge_v(j = 1) %>% 
  fontsize(size = 10) %>%
  bold(part = "header") %>%
  align(j = 1:2, align = "left", part = "all") %>%  
  align(j = 3:9, align = "center", part = "all") %>%  
  border_outer() %>%
  border_inner_h() %>%
  border_inner_v() %>%
  set_table_properties(layout = "autofit") %>%
  bg(part = "header", bg = "pink") 

ft_num
```

<h2 style="text-align: center;">Категориальные переменные</h2>


```{r, echo=FALSE, error=FALSE, warning=FALSE, message=FALSE}
cat_table <- CrohnD %>% 
  summarise(
    .by = treat,
    country_c1_n = sum(country == "c1", na.rm = TRUE) %>% as.character(),
    country_c1_p = ifelse(sum(!is.na(country)) == 0, "Н/Д", 
                         round(sum(country == "c1", na.rm = TRUE) / sum(!is.na(country)) * 100, 1) %>% paste0("%")),
    country_c2_n = sum(country == "c2", na.rm = TRUE) %>% as.character(),
    country_c2_p = ifelse(sum(!is.na(country)) == 0, "Н/Д", 
                         round(sum(country == "c2", na.rm = TRUE) / sum(!is.na(country)) * 100, 1) %>% paste0("%")),
    sex_F_n = sum(sex == "F", na.rm = TRUE) %>% as.character(),
    sex_F_p = ifelse(sum(!is.na(sex)) == 0, "Н/Д", 
                    round(sum(sex == "F", na.rm = TRUE) / sum(!is.na(sex)) * 100, 1) %>% paste0("%")),
    sex_M_n = sum(sex == "M", na.rm = TRUE) %>% as.character(),
    sex_M_p = ifelse(sum(!is.na(sex)) == 0, "Н/Д", 
                    round(sum(sex == "M", na.rm = TRUE) / sum(!is.na(sex)) * 100, 1) %>% paste0("%"))
  ) %>% 
  pivot_longer(!treat, names_to = "variable", values_to = "value") %>%
  separate(variable, into = c("Переменная", "Уровень", "Тип"), sep = "_") %>%
  pivot_wider(names_from = "Тип", values_from = "value") %>%
  mutate(
    Переменная = case_when(
      Переменная == "country" ~ "Страна",
      Переменная == "sex" ~ "Пол",
      TRUE ~ Переменная
    ),
    Уровень = case_when(
      Уровень == "c1" ~ "Страна 1",
      Уровень == "c2" ~ "Страна 2", 
      Уровень == "F" ~ "Женщины",
      Уровень == "M" ~ "Мужчины",
      TRUE ~ Уровень
    ),
    treat = case_when(
      treat == "placebo" ~ "Плацебо",
      treat == "d1" ~ "Препарат 1",
      treat == "d2" ~ "Препарат 2",
      TRUE ~ treat
    )
  ) %>%
  rename(
    Препарат = treat,
    `Количество` = n,
    `%` = p
  ) %>%
  select(Препарат, Переменная, Уровень, `Количество`, `%`)

ft_cat <- flextable(cat_table) %>%
  merge_v(j = "Препарат") %>%
  merge_v(j = "Переменная") %>%
  fontsize(size = 10) %>%
  bold(part = "header") %>%
  align(j = 1:3, align = "left", part = "all") %>%  
  align(j = 4:5, align = "center", part = "all") %>%  
  border_outer() %>%
  border_inner_h() %>%
  border_inner_v() %>%
  set_table_properties(layout = "autofit") %>%
  bg(part = "header", bg = "pink")

ft_cat
```


2. Визуализировать распределения значений признаков средствами ggplot2 и сопутствующих пакетов.

### Настройка темы

```{r}
theme_custom <-
  theme(
        axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20, margin = margin(t = 15, unit = "pt")),
        axis.title.x = element_text(size = 24),
        axis.title.y = element_text(size = 24),
        panel.background = element_rect(fill = "#f8f9fa"),
        legend.text = element_text(size=18),
        legend.title = element_text(size=22),
        plot.title = element_text(size=28)
  )
```
```{r BMI_AE,  fig.width=16, fig.height=9}
# p1 <- CrohnD %>% 
#   select(nrAdvE, BMI) %>% 
#   ggplot(aes(x = BMI, y = nrAdvE)) +
#   geom_jitter(aes(colour = BMI), size = 2) +
#   theme_custom+
#   labs(x = "Индекс массы тела", y = "Количество НЯ")+
#   scale_color_continuous(name="ИМТ")
```

```{r height_AE,  fig.width=16, fig.height=9}
# p2 <- CrohnD %>% 
#   select(nrAdvE, height) %>% 
#   ggplot(aes(x = height, y = nrAdvE)) +
#   geom_jitter(aes(colour = height), , size = 2) +
#   theme_custom+
#   labs(x = "Рост, см", y = "Количество НЯ")+
#   scale_color_continuous(name="Рост, см")
```

```{r country_AE,  fig.width=16, fig.height=9}
# p3 <- CrohnD %>% 
#   select(nrAdvE, country) %>% 
#   ggplot() +
#   geom_bar(aes(y = nrAdvE, fill = country)) +
#   theme_custom+
#   labs(x = "Количество пациентов", y = "Количество НЯ") +
#   scale_fill_manual(
#     name = "Страна",
#     labels = c(
#       "c1" = "Страна 1",
#       "c2" = "Страна 2"
#     ),
#     values = c(
#       "c1" = "#0a9396",
#       "c2" = "#ee9b00" 
#     ))
```

```{r, fig.width=12, fig.height=9}
# p4 <- CrohnD %>% 
#   select(nrAdvE, sex) %>% 
#   ggplot() +
#   geom_violin(aes(x = sex, y = nrAdvE, fill = sex), alpha = 0.5)+
#   geom_boxplot(aes(x = sex, y = nrAdvE), width = 0.1, color = "grey", alpha = 0.5)+
#   labs(x = "Пол", y = "Количество НЯ")+
#   scale_fill_manual(
#     name = "Пол",
#     labels = c(
#       "F" = "Ж",
#       "M" = "М"
#     ),
#     values = c(
#       "M" = "#6930c3",
#       "F" = "#f15bb5" 
#     ))+
#   theme_custom+
#   scale_x_discrete(labels = c(
#       "F" = "Ж",
#       "M" = "М"
#     ))
#   #scale_color_continuous(name="ИМТ")
```

```{r, fig.width=16, fig.height=12}
#(p1+p2)/(p3+p4)
```

### Распределение значений признаков

```{r hist_AE, fig.width=16, fig.height=6}
p5 <- CrohnD %>% 
  select(nrAdvE) %>% 
  ggplot() +
  geom_bar(aes(x = nrAdvE), fill = "#e07a5f") +
  theme_custom+
  labs(y = "Количество пациентов", x = "Количество НЯ", title = "Распределение количества НЯ")
```

```{r hist_height, fig.width=16, fig.height=6}
p6 <- CrohnD %>% 
  select(height) %>% 
  ggplot() +
  geom_bar(aes(x = height), fill = "#81B29A") +
  theme_custom+
  scale_y_continuous(breaks = seq(0, 12, by = 2))+
  scale_x_continuous(breaks = seq(100, 200, by = 10))+
  labs(y = "Количество пациентов", x = "Рост, см", title = "Распределение по росту")
```

```{r hist_country, fig.width=6, fig.height=12}
p7 <- CrohnD %>% 
  select(country) %>% 
  ggplot() +
  geom_bar(aes(x = country), width = 0.4, fill = "#F2CC8F") +
  theme_custom+
  scale_y_continuous(limits=c(0,100), breaks = seq(0, 100, by = 10))+
  labs(y = "Количество пациентов", x = "Страна", title = "Распределение по стране")+
  scale_x_discrete(labels = c(
      "c1" = "Страна 1",
      "c2" = "Страна 2"
    ))
```

```{r hist_sex, fig.width=6, fig.height=12}
p8 <- CrohnD %>% 
  select(sex) %>% 
  ggplot() +
  geom_bar(aes(x = sex, fill = as.factor(sex)), width = 0.4) +
  scale_y_continuous(breaks = seq(0, 100, by = 10))+
  theme_custom+
  labs(y = "Количество пациентов", x = "Пол", title = "Распределение по полу")+
    scale_fill_manual(
    name = "Пол",
    labels = c(
      "F" = "Ж",
      "M" = "М"
    ),
    values = c(
      "M" = "#4A5899",
      "F" = "#FFC4EB" 
    ))+
  scale_x_discrete(labels = c(
      "F" = "Ж",
      "M" = "М"
    ))  
```

```{r hist_age, fig.width=16, fig.height=6}
p9 <- CrohnD %>% 
  select(age) %>% 
  ggplot() +
  geom_bar(aes(x = age), fill = "#76D0AF") +
  theme_custom+
  scale_x_continuous(breaks = seq(0, 100, by = 10))+
  scale_y_continuous(breaks = seq(0, 10, by = 2))+
  labs(y = "Количество пациентов", x = "Возраст, лет", title = "Распределение по возрасту")
```

```{r hist_weight, fig.width=16, fig.height=6}
p10 <- CrohnD %>% 
  select(weight) %>% 
  ggplot() +
  geom_bar(aes(x = weight), fill = "#99D6FF") +
  theme_custom+
  scale_x_continuous(breaks = seq(0, 120, by = 10))+
  labs(y = "Количество пациентов", x = "Вес, кг", title = "Распределение по весу")
```

```{r, fig.width=16, fig.height=12}
(p5/p6) 
```

```{r, fig.width=12, fig.height=9}
p7 + p8
```

```{r, fig.width=16, fig.height=12}
p9/p10
```

```{r, fig.width=16, fig.height=9}
p11 <- CrohnD %>% 
  select(treat) %>% 
  ggplot() +
  geom_bar(aes(x = treat, fill = as.factor(treat)), width = 0.4) +
  scale_y_continuous(breaks = seq(0, 40, by = 5))+
  theme_custom+
  labs(y = "Количество пациентов", x = "Группа", title = "Распределение по группе лечения")+
    scale_fill_manual(
    name = "Группа",
    labels = c(
      "d1" = "Препарат 1",
      "d2" = "Препарат 2",
      "placebo" = "Плацебо"
    ),
    values = c(
      "d1" = "#2274A5",
      "d2" = "#E07A5F",
      "placebo" = "#FFBF00"
    ))+
  scale_x_discrete(labels = c(
      "d1" = "Препарат 1",
      "d2" = "Препарат 2",
      "placebo" = "Плацебо"
    ))  
```

```{r, fig.width=16, fig.height=9}
p11
```

```{r BMI, fig.width=16, fig.height=6}
p12 <- CrohnD %>% 
  select(BMI) %>% 
  ggplot() +
  geom_bar(aes(x = BMI), fill = "#D7E8BA", width = 0.3) +
  theme_custom+
  #scale_x_continuous(breaks = seq(0, 120, by = 10))+
  labs(y = "Количество пациентов", x = "ИМТ, кг/м^2", title = "Распределение по ИМТ")

#выглядит не очень
```

3.  Подобрать и реализовать средства для визуальной оценки взаимосвязи между числом НЯ и собранными признаками пациентов.

```{r}

CrohnD %>% 
  select(-rownames, -ID) %>% 
  mutate(
    sex = factor(sex),
    country = factor(country),
    treat = factor(treat)
  ) -> corr_data

ggpairs(
  data = corr_data,
  progress = FALSE,
  upper = list(continuous = wrap("cor", method = "spearman"))
) +
  theme_bw()

# пол
p1 <- ggplot(corr_data, aes(x = sex, y = nrAdvE)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.4) +
  theme_bw() +
  labs(title = "Число НЯ по полу")

# лечение
p2 <- ggplot(corr_data, aes(x = treat, y = nrAdvE)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.4) +
  theme_bw() +
  labs(title = "Число НЯ по лечению")

# страна
p3 <- ggplot(corr_data, aes(x = country, y = nrAdvE)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.4) +
  theme_bw() +
  labs(title = "Число НЯ по стране")

p1+p2+p3
# num_corr <- corr_data %>%
#   select(where(is.numeric)) %>%
#   psych::corr.test(method = "spearman")
# 
# ggcorrplot(
#   num_corr$r,
#   hc.order = TRUE,
#   type = "lower",
#   p.mat = num_corr$p,
#   sig.level = 0.05,
#   lab = TRUE
# )



str(CrohnD)
describe(CrohnD)
```

4.  Выбрать и реализовать методы однофакторного анализа для количественной оценки взаимосвязи между числом НЯ и собранными признаками пациентов (помните, что взаимосвязь - это не только p-значения, но и доверительные интервалы!).

```{r independent_ttest}
################# Сравнение НЯ и пола ##########################

# Группы: Две независимые группы (М и Ж).
# Нулевая гипотеза (H_0): Средний уровень НЯ одинаков для обеих групп.

# Проверяем, различаются ли дисперсии в распределении количества НЯ у двух групп
CrohnD_male <- filter(CrohnD, sex == 'M')
sd_male <- sd(CrohnD_male$nrAdvE) 
sd_male

CrohnD_female <- filter(CrohnD, sex == 'F')
sd_female <- sd(CrohnD_female$nrAdvE) 
sd_female

# Вывод: SD  в обеих группах отличаются

# Выполняем t-критерий для независимых выборок (М и Ж)
t_test_ind <- t.test(nrAdvE ~ sex, data = CrohnD, var.equal = FALSE) # дисперсии не равны

# Выводим результаты
cat("### t-критерий для независимых выборок: НЯ по полу\n")
print(t_test_ind)

# Находим разницу средних для двух групп (М и Ж)

mean_male <- mean(CrohnD_male$nrAdvE) 
mean_female <- mean(CrohnD_female$nrAdvE) 
md_sex =  mean_male - mean_female
md_sex

################# Сравнение НЯ и страны ##########################

# Группы: Две независимые группы (c1 и c2).
# Нулевая гипотеза (H_0): Средний уровень НЯ одинаков для обеих групп.

# Проверяем, различаются ли дисперсии в распределении количества НЯ у двух групп
CrohnD_c1 <- filter(CrohnD, country == 'c1')
sd_c1 <- sd(CrohnD_c1$nrAdvE) 
sd_c1

CrohnD_c2 <- filter(CrohnD, country == 'c2')
sd_c2 <- sd(CrohnD_c2$nrAdvE) 
sd_c2

# Вывод: SD  в обеих группах практически не отличаются

# Выполняем t-критерий для независимых выборок (c1 и c2)
t_test_country <- t.test(nrAdvE ~ country, data = CrohnD, var.equal = TRUE) # равенство дисперсий

# Выводим результаты
cat("### t-критерий для независимых выборок: НЯ по странам\n")
print(t_test_country)

# Находим разницу средних для двух групп (c1 и c2)

mean_c1 <- mean(CrohnD_c1$nrAdvE) 
mean_c2 <- mean(CrohnD_c2$nrAdvE) 
md_country =  mean_c2 - mean_c1
md_country

################# Сравнение НЯ и лечения ##########################

# Цель: Сравнить средний уровень НЯ между пациентами с разным лечением
# Группы: Две независимые группы (placebo и d1).
# Нулевая гипотеза (H_0): Средний уровень НЯ одинаков для обеих групп.

# Проверяем, различаются ли дисперсии в распределении количества НЯ у двух групп

CrohnD_placebo <- filter(CrohnD, treat == 'placebo')
sd_placebo <- sd(CrohnD_placebo$nrAdvE) 
sd_placebo

CrohnD_d1 <- filter(CrohnD, treat == 'd1')
sd_d1 <- sd(CrohnD_d1$nrAdvE) 
sd_d1

# Вывод: SD  в обеих группах отличаются

placebo_d1 <- c('placebo', 'd1')
placebo_d1=subset(CrohnD,treat %in% unique(placebo_d1)) 

# Выполняем t-критерий для независимых выборок (placebo и d1)
t_test_placebo_d1 <- t.test(nrAdvE ~ treat, data = placebo_d1, var.equal = FALSE) # дисперсии не равны

# Выводим результаты
cat("### t-критерий для независимых выборок: НЯ между placebo и d1\n")
print(t_test_placebo_d1)

# Находим разницу средних для двух групп (placebo и d1)

mean_placebo <- mean(CrohnD_placebo$nrAdvE) 
mean_d1 <- mean(CrohnD_d1$nrAdvE) 
md_placebo_d1 =  mean_placebo - mean_d1
md_placebo_d1

# Цель: Сравнить средний уровень НЯ между пациентами с разным лечением
# Группы: Две независимые группы (placebo и d2).
# Нулевая гипотеза (H_0): Средний уровень НЯ одинаков для обеих групп.

# Проверяем, различаются ли дисперсии в распределении количества НЯ у двух групп

sd_placebo

CrohnD_d2 <- filter(CrohnD, treat == 'd2')
sd_d2 <- sd(CrohnD_d2$nrAdvE) 
sd_d2

# Вывод: SD  в обеих группах отличаются

placebo_d2 <- c('placebo', 'd2')
placebo_d2=subset(CrohnD,treat %in% unique(placebo_d2)) 

# Выполняем t-критерий для независимых выборок (placebo и d1)
t_test_placebo_d2 <- t.test(nrAdvE ~ treat, data = placebo_d2, var.equal = FALSE) # дисперсии не равны

# Выводим результаты
cat("### t-критерий для независимых выборок: НЯ между placebo и d1\n")
print(t_test_placebo_d2)

# Находим разницу средних для двух групп (placebo и d2)

mean_d2 <- mean(CrohnD_d2$nrAdvE) 
md_placebo_d2 =  mean_placebo - mean_d2
md_placebo_d2

# Цель: Сравнить средний уровень НЯ между пациентами с разным лечением
# Группы: Две независимые группы (d1 и d2).
# Нулевая гипотеза (H_0): Средний уровень НЯ одинаков для обеих групп.

# Проверяем, различаются ли дисперсии в распределении количества НЯ у двух групп

sd_d1
sd_d2

# Вывод: SD  в обеих группах практически не отличаются

d1_d2 <- c('d1', 'd2')
d1_d2=subset(CrohnD,treat %in% unique(d1_d2)) 

# Выполняем t-критерий для независимых выборок (placebo и d1)
t_test_d1_d2 <- t.test(nrAdvE ~ treat, data = d1_d2, var.equal = TRUE) # дисперсии равны

# Выводим результаты
cat("### t-критерий для независимых выборок: НЯ между placebo и d1\n")
print(t_test_d1_d2)

# Находим разницу средних для двух групп (placebo и d2)

md_d1_d2 =  mean_d1 - mean_d2
md_d1_d2

```
## Интерпретация результатов

1. **Статистическая значимость**: p-value = 0.3207 > 0,05 свидетельствует о статистически незначимом различии между группами, разделенными по полу, стране и терапии.

2. **Разность средних**: -0.5641026 (нет существенных различий в количестве НЯ между группами)

3. **t-статистика**: около t = -0.99962 (отрицательное значение указывает на то, что первая группа 'd1' имеет меньшее среднее значение, чем вторая группа 'd2')

4. **Степени свободы**: df = 76 (размер выборки с терапией d1 или d2)

5. **Доверительный интервал**: 95% доверительный интервал для разности средних составляет [-1.6880377  0.5598326], что означает, что мы можем быть на 95% уверены, что истинная разность между группами находится в этом интервале.

6. **Клиническая значимость**: Разность в ~0.6  является **клинически не значимой**

**Заключение**: Не найдено статистически и клинически значимых различий в количестве НЯ после лечения болезни Крона между пациентами с терапией d1 и d2.

Приблизительно такие же результаты были получены при сравнении групп М и Ж, страна 1 и страна 2, placebo И d1, placebo и d2.